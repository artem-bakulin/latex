\documentclass{beamer}

\usepackage{cmap}				% To be able to copy-paste russian text from pdf
\usepackage[T2A]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[russian]{babel}
\usepackage{textpos}
\usepackage{ragged2e}
\usepackage{amssymb}
\usepackage{ulem}
\usepackage{tikz}
\usepackage{pgfplots}
\usepackage{color}
\usepackage{cancel}
\usepackage{multirow}
\pgfplotsset{compat=1.17}
\usetikzlibrary{arrows,snakes,backgrounds,shapes}
\usepgfplotslibrary{groupplots,colorbrewer,dateplot,statistics}
\usepackage{animate}

\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{setspace}

\usepackage{enumitem}
\setitemize{label=\usebeamerfont*{itemize item}%
  \usebeamercolor[fg]{itemize item}
  \usebeamertemplate{itemize item}}

% remove navigation bar
\setbeamertemplate{navigation symbols}{} 

\usepackage{eurosym}
\renewcommand{\EUR}[1]{\textup{\euro}#1}

\title{Лекция 4. Улыбка волатильности. Греки}
\author{Артём Бакулин}
\date{28 октября 2021 г.}

\usetheme{Warsaw}
\usecolortheme{beaver}

\newcommand{\ru}[1]{\begin{otherlanguage}{russian}#1\end{otherlanguage}}
\newcommand{\en}[1]{\begin{otherlanguage}{english}#1\end{otherlanguage}}
\newcommand{\ruen}[2]{#1 (\en{#2})}

\begin{document}



\begin{frame}
\titlepage
\end{frame}



\begin{frame}{Напоминание: модель Блэка-Шоулза}
\justify
В модели Блэка-Шоулза процентное изменение цены $dS_t/S_t$ за каждый малый период $dt$ имеет нормальное распределение с трендом $\mu$ и волатильностью $\sigma$:
\begin{align*}
\frac{dS_t}{S_t} = \mu dt + \sigma\varepsilon\sqrt{dt}, \quad \varepsilon \sim \mathcal{N}(0, 1)
\end{align*}

\justify
Если сложить все малые колебания за интервал длиной $T$, то цена базового актива имеет логнормальное распределение:
\begin{align*}
S(T) &= S_0 \exp\left[\left(r - \dfrac{\sigma^2}{2}\right)T + \sigma\varepsilon\sqrt{T}\right], \quad \varepsilon \sim \mathcal{N}(0, 1) \\
\ln\left(S(T)\right) &= \ln\left(S_0\right) + \left(r - \dfrac{\sigma^2}{2}\right)T + \sigma\varepsilon\sqrt{T}
\end{align*}
\end{frame}



\begin{frame}{Напоминание: модель Блэка-Шоулза}
\justify
Цена колл-опциона со страйком $K$ и сроком погашения $T$ зависит от текущей цены базового актива $S_0$, его волатильности $\sigma$ и безрисковой процентной ставки $r$:
\begin{align*}
C &= S_0N(d_1) - Ke^{-rT}N(d_2)
\end{align*}
где
\begin{align*}
d_1 &= \dfrac{1}{\sigma\sqrt{T}}\left( \ln\left(\dfrac{S_0}{K}\right) + \left(r + \dfrac{\sigma^2}{2}\right)T\right) \\
d_2 &= \dfrac{1}{\sigma\sqrt{T}}\left( \ln\left(\dfrac{S_0}{K}\right) + \left(r - \dfrac{\sigma^2}{2}\right)T\right) \\
N(x) &= \dfrac{1}{\sqrt{2\pi}}\int\limits_{-\infty}^x e^{-\dfrac{t^2}{2}}dt
\end{align*}
\end{frame}



\begin{frame}{Историческая волатильность}
\justify
Если мы живём в мире Блэка-Шоулза, то нам достаточно знать волатильность базового актива, чтобы посчитать справедливую цену любого опциона. Почему бы не посмотреть на историю?

\justify
Рассмотрим временной ряд исторических цен базового актива $S_0,S_1,...,S_n$, взятых с фиксированным шагом $\Delta t$. Например, если у нас есть дневные данные, то $\Delta t = 1/250$ (по количеству рабочих дней в году). 

\justify
Посчитаем логарифмические доходности (\en{log returns}), которые близки к простым процентным доходностям:
\begin{align*}
r_i &= \ln \left( \dfrac{S_{i}}{S_{i-1}} \right) \\
\ln \left(\dfrac{S_{i}}{S_{i-1}} \right) &= \ln \left[1 + \left(\dfrac{S_{i}}{S_{i-1}} - 1 \right) \right] \approx \dfrac{S_{i}}{S_{i-1}} - 1
\end{align*}
\end{frame}



\begin{frame}{Историческая волатильность}
\justify
В модели Блэка-Шоулза все лог-доходности $r_i$ --- н.о.р.с.в. Их выборочное стандартное отклонение --- историческая (\en{historical}) или реализованная (\en{realized}) волатильность.

\begin{align*}
\hat{r} &= \frac{1}{n}\sum\limits_{i=1}^{n}r_i \\
\hat{\sigma} &= \sqrt{\frac{1}{n-1}\sum\limits_{i=1}^{n}(r_i - \hat{r})^2}
\end{align*}

\justify
Чтобы перевести <<дневную>> волатильность в проценты годовых, нужно разделить её на $\sqrt{\Delta t}$.
\end{frame}



\begin{frame}{Историческая волатильность}
\centering
\begin{tikzpicture}
\begin{axis}[
  width=\textwidth,
  height=\textheight - 1cm,
  date coordinates in=x,
  date ZERO=2012-01-01,
  xtick={2012-01-01, 2014-01-01, 2016-01-01, 2018-01-01, 2020-01-01, 2022-01-01},
  minor xtick={2013-01-01, 2015-01-01, 2017-01-01, 2019-01-01, 2021-01-01},
  ytick={30, 40, ..., 90},
%  minor ytick={-0.75, -0.25, 0.25, 0.75, 1.25},
  xticklabel={\year},
  xmin=2012-01-01,
  xmax=2022-01-01,
  ymin=20,
  ymax=90,
  grid=both,
  %yticklabel={\pgfmathprintnumber{\tick}\%},
  ylabel={\small{Курс USDRUB}},
  xlabel near ticks,
  ylabel near ticks
]

\addplot[color = Set1-B, mark = none, very thick]
	table[
		x=date,
		y=fx_rate,
		col sep=comma
	]
	{cbr.USD.2012.2021.csv};

\end{axis}
\end{tikzpicture}

\scriptsize Данные: ЦБ РФ.
\end{frame}



\begin{frame}{Историческая волатильность}
\centering
\begin{tikzpicture}
\begin{axis}[
  width=\textwidth,
  height=\textheight - 1cm,
  date coordinates in=x,
  date ZERO=2012-01-01,
  xtick={2012-01-01, 2014-01-01, 2016-01-01, 2018-01-01, 2020-01-01, 2022-01-01},
  minor xtick={2013-01-01, 2015-01-01, 2017-01-01, 2019-01-01, 2021-01-01},
  ytick={0.1, 0.2, ..., 1},
%  minor ytick={-0.75, -0.25, 0.25, 0.75, 1.25},
  xticklabel={\year},
  xmin=2012-01-01,
  xmax=2022-01-01,
  ymin=0,
  ymax=0.9,
  grid=both,
  yticklabel={\pgfmathparse{\tick*100}\pgfmathprintnumber[precision=0]{\pgfmathresult}\%},
  ylabel={\small{Реализованная волатильность}},
  xlabel near ticks,
  ylabel near ticks
]

\addplot[color = Set1-B, mark = none, thick]
	table[
		x=mid_month,
		y=realized_vol,
		col sep=comma
	]
	{USDRUB_realized_vol.csv};

\end{axis}
\end{tikzpicture}

\scriptsize Данные: ЦБ РФ.
\end{frame}



\begin{frame}{Историческая волатильность}
\justify
Историческая волатильность --- не константа, что противоречит модели Блэка-Шоулза. В прошлом мы видели большой разброс в реализованной волатильности. Сложно выбрать репрезентативный период, который хорошо подходил бы тому опциону (скажем, на 3 месяца), который мы пытаемся оценить.

\justify
Прошлое не предсказывает будущее!
\end{frame}



\begin{frame}{Ожидаемая волатильность}
\justify
В модели Блэка-Шоулза цена опциона зависит от волатильности:
\begin{align*}
C_K = F(S_0, T, K, \sigma, r)
\end{align*}

\justify
Мы можем посмотреть на рыночные цены опционов и решить задачу в обратном направлении. 

\justify
Если участники рынка пользуются моделью Блэка-Шоулза, то какую волатильность они подставляют в формулу, чтобы получить те премии, которые мы наблюдаем?
\begin{align*}
\sigma = F^{-1}(S_0, T, K, r, C_K)
\end{align*}

\justify
Решение этой обратной задачи --- ожидаемая (\en{implied}) волатильность.
\end{frame}



\begin{frame}{Ожидаемая волатильность}
\justify
Опционы на USDRUB с экспирацией 16.12.2021.

\centering
\begin{tikzpicture}
\begin{axis}[
			width = \textwidth,
			height = \textheight - 2cm,
			domain=60:84,
			xtick={60,62,...,84},
			ytick={1,2,...,13},
			xmin=60, xmax=84,
			ymin=0, ymax=13,
			grid = major,
			xlabel={Страйк ($K$)},
			ylabel={Цена опциона, руб.}
]

	\addplot[color = Set1-A, mark = none, thick]
	table[
		x=strike,
		y=call,
		col sep=comma
	]
	{usdrub_implied_vol.csv};
	
	\addplot[color = Set1-B, mark = none, thick]
	table[
		x=strike,
		y=put,
		col sep=comma
	]
	{usdrub_implied_vol.csv};
\end{axis}
\end{tikzpicture}

\scriptsize Данные: Московская биржа.
\end{frame}



\begin{frame}{Ожидаемая волатильность}
\justify
Опционы на USDRUB с экспирацией 16.12.2021.

\centering
\begin{tikzpicture}
\begin{axis}[
			width = \textwidth,
			height = \textheight - 2cm,
			domain=60:84,
			xtick={60,62,...,84},
			ytick={0.02,0.04,...,0.24},
			xmin=60, xmax=84,
			ymin=0, ymax=0.24,
			yticklabel={\pgfmathparse{\tick*100}\pgfmathprintnumber[precision=0]{\pgfmathresult}\%},
			grid = major,
			xlabel={Страйк ($K$)},
			ylabel={Волатильность ($\sigma$)}
]

	\addplot[color = Set1-B, mark = none, thick]
	table[
		x=strike,
		y=iv,
		col sep=comma
	]
	{usdrub_implied_vol.csv};
\end{axis}
\end{tikzpicture}

\scriptsize Данные: Московская биржа.
\end{frame}



\begin{frame}{Ожидаемая волатильность}
\justify
Опционы на S\&P\,500 с экспирацией 17.12.2021.

\centering
\begin{tikzpicture}
\begin{axis}[
			width = \textwidth,
			height = \textheight - 2cm,
			domain=4000:5000,
			xtick={4000,4100,...,5000},
			ytick={50,100,...,600},
			xmin=4000, xmax=5000,
			ymin=0, ymax=600,
			grid = major,
			xlabel={Страйк ($K$)},
			ylabel={Цена опциона, \$},
			xticklabel={\pgfmathprintnumber[precision=0, 1000 sep={}]{\tick}}
]

	\addplot[color = Set1-A, mark = none, thick]
	table[
		x=strike,
		y=call,
		col sep=comma
	]
	{sp500_implied_vol.csv};
	
	\addplot[color = Set1-B, mark = none, thick]
	table[
		x=strike,
		y=put,
		col sep=comma
	]
	{sp500_implied_vol.csv};
\end{axis}
\end{tikzpicture}

\scriptsize Данные: barchart.com.
\end{frame}



\begin{frame}{Ожидаемая волатильность}
\justify
Опционы на S\&P\,500 с экспирацией 17.12.2021.

\centering
\begin{tikzpicture}
\begin{axis}[
			width = \textwidth,
			height = \textheight - 2cm,
			domain=4000:5000,
			xtick={4000,4100,...,5000},
			ytick={0.05,0.10,...,0.25},
			xmin=4000, xmax=5000,
			ymin=0, ymax=0.25,
			grid = major,
			xlabel={Страйк ($K$)},
			ylabel={Волатильность ($\sigma$)},
			xticklabel={\pgfmathprintnumber[precision=0, 1000 sep={}]{\tick}},
			yticklabel={\pgfmathparse{\tick*100}\pgfmathprintnumber[precision=0]{\pgfmathresult}\%},
]

	\addplot[color = Set1-B, mark = none, thick]
	table[
		x=strike,
		y=iv,
		col sep=comma
	]
	{sp500_implied_vol.csv};
\end{axis}
\end{tikzpicture}

\scriptsize Данные: barchart.com.
\end{frame}



\begin{frame}{Улыбка волатильности}
\justify
Почти на всех рынках наблюдается зависимость ожидаемой (\en{implied}) волатильности от страйка опциона. Дальние \en{out of the money}\ опционы стоят дороже (в терминах волатильности), чем можно было бы ожидать.
\begin{itemize}
\item Улыбка (\en{smile}). Например, на рынке FX.
\item Ухмылка (\en{skew, smirk}). Например, на рынке акций.
\end{itemize}

\justify
Может ли быть так, что базовый актив ведёт себя по-разному в зависимости от того, какой опцион (с каким страйком) сейчас оценивают участники рынка? Нет!

\justify
Либо все участники опционного рынка сошли с ума, либо модель Блэка-Шоулза не до конца описывает реальность. Предположение о постоянной волатильности и логнормальном распределении будущей цены базового актива выглядит слишком строгим.
\end{frame}



\begin{frame}{Опционная бабочка}
\justify
Попробуем оценить, какое распределение, если не лог-нормальное, ожидают участники рынка.

\justify
Рассмотрим комбинацию опционов <<бабочка>> (\en{butterfly, fly}):
\begin{itemize}
\item Купленный колл со страйком $K - \delta$.
\item Два проданных колла со страйком $K$.
\item Купленный колл со страйком $K + \delta$.
\end{itemize}

\justify
Купленные опционы --- <<крылья>> (\en{wings}), а проданные --- <<тельце>> (\en{belly}).
\end{frame}



\begin{frame}{Опционная бабочка}
\justify
Пример: бабочка со страйками 70, 72 и 74.

\centering
	\begin{tikzpicture}
		\begin{axis}[
			domain=64:80,
			%axis lines=middle,
			xtick={64,66,...,80},
			ytick={-6,-5,...,6},
			xmin=64, xmax=80,
			ymin=-6, ymax=6,
			%x label style={at={(axis description cs: 0.5, -0.1)}, anchor=north},
			%y label style={at={(axis description cs:-0.1,1)},anchor=south},
			grid = major,
			xlabel={Курс в дату экспирации},
			ylabel={Выплата (payoff)},
			%scaled x ticks=false
		]
		
	\addplot[Set1-B, very thick, dashed] {(\x > 74)*(\x - 74) + 0.15};
  	\addplot[Set1-C, very thick, dashed] {(\x > 70)*(\x - 70) + 0.15};
  	\addplot[Set1-D, very thick, dashed] {2*(\x > 72)*(72 - \x) - 0.15};
 
 	\addplot[Set1-A, very thick] {(\x > 74)*(\x - 74) + (\x > 70)*(\x - 70) + 2*(\x > 72)*(72 - \x)};
 
   \draw[thick, color=black] (axis cs: 60, 0) -- (axis cs: 90, 0);
\end{axis}
\end{tikzpicture}
\end{frame}



\begin{frame}{Опционная бабочка}
\justify
Пример: бабочка со стайками 71, 72 и 73.

\centering
	\begin{tikzpicture}
		\begin{axis}[
			width = \textheight,
			height = \textheight*0.5,
			domain=64:80,
			%axis lines=middle,
			xtick={64,66,...,80},
			ytick={0,...,6},
			xmin=64, xmax=80,
			ymin=-1, ymax=3,
			%x label style={at={(axis description cs: 0.5, -0.1)}, anchor=north},
			%y label style={at={(axis description cs:-0.1,1)},anchor=south},
			grid = major,
			xlabel={Курс в дату экспирации},
			ylabel={Выплата (payoff)},
			%scaled x ticks=false
		]
		
 	\addplot[Set1-A, very thick, samples at={64,64.1,...,80}] {(\x > 71)*(\x - 71) + (\x > 73)*(\x - 73) + 2*(\x > 72)*(72 - \x) + 0.05};
 
   \draw[thick, color=black] (axis cs: 60, 0) -- (axis cs: 90, 0);
\end{axis}
\end{tikzpicture}

\justify
По мере того, как разность между <<крыльями>> уменьшается, бабочка превращается в ставку на то, что цена базового актива остановится вблизи центрального страйка.
\end{frame}



\begin{frame}{Опционная бабочка}
\justify
Бабочки со страйками $K-1$, $K$ и $K+1$. Экспирация 16.12.2021.

\centering
\begin{tikzpicture}
\begin{axis}[
			width = \textwidth,
			height = \textheight - 2cm,
			domain=60:84,
			xtick={60,62,...,84},
			ytick={0.02,0.04,...,0.18},
			xmin=60, xmax=84,
			ymin=0, ymax=0.18,
			yticklabel={\pgfmathprintnumber[fixed, fixed zerofill, precision=2]{\tick}},
			grid = major,
			xlabel={Страйк ($K$)},
			ylabel={Цена бабочки, руб.}
]

	\addplot[color = Set1-B, mark = none, thick]
	table[
		x=strike,
		y=fly,
		col sep=comma
	]
	{usdrub_fly.csv};
\end{axis}
\end{tikzpicture}

\scriptsize Данные: Московская биржа.
\end{frame}



\begin{frame}{Ожидаемое распределение}
\centering
\begin{tikzpicture}
\begin{axis}[
			width = \textwidth,
			height = \textheight - 2cm,
			domain=60:84,
			xtick={60,62,...,84},
			ytick={0.02,0.04,...,0.18},
			xmin=60, xmax=84,
			ymin=0, ymax=0.18,
			yticklabel={\pgfmathprintnumber[fixed, fixed zerofill, precision=2]{\tick}},
			grid = major,
			xlabel={Страйк ($K$)},
			ylabel={Плотность распределения},
			legend entries = {
				\small Ожидаемое,
				\small Логнормальное
			},
  			legend cell align={left},
 		 	legend style={at={(0.97,0.97)},anchor=north east}
]

	\addplot[color = Set1-B, mark = none, thick]
	table[
		x=strike,
		y=implied_density,
		col sep=comma
	]
	{usdrub_implied_density.csv};
	
	\addplot[color = Set1-A, mark = none, dashed, thick]
	table[
		x=strike,
		y=lognormal_density,
		col sep=comma
	]
	{usdrub_implied_density.csv};
\end{axis}
\end{tikzpicture}

\scriptsize Данные: Московская биржа.
\end{frame}



\begin{frame}{Ожидаемое распределение}
\justify
Обычно цены опционов подразумевают распределение, отличное от логнормального. Часто можно видеть толстые хвосты и скошенность влево или вправо.

\justify
Мы не знаем, как в точности объясняется этот эффект:
\begin{itemize}
\item Участники рынка верно оценивают истинную вероятность экстремальных исходов (больших изменений цены базового актив).
\item Участникам рынка настолько больно от экстремальных исходов, что они готовы переплатить за страховку. Это стремление застраховаться и избежать риска увеличивает рыночную цену опционов относительно <<фундаментально обоснованной>>.
\end{itemize}

\justify
Как обычно, если мы можем использовать ликвидные опционы для хэджирования риска и репликации более сложных экзотических продуктов, то нам не важно, какое объяснение верное.
\end{frame}



\begin{frame}{Модели волатильности}
\justify
Существование улыбки волатильности опровергает гипотезу о геометрическом броуновском движении с постоянной волатильностью. Как можно изменить модель движения базового актива, чтобы новая модель объясняла улыбку волатильности (давала те же премии, которые мы видим на рынке).

\justify
\begin{itemize}
\item Локальная волатильность.
\item Стохастическая волатильность.
\item Стохастическая локальная волатильность.
\item Стохастическая локальная волатильность с прыжками.
\item ...
\end{itemize}
\end{frame}



\begin{frame}{Локальная волатильность}
\justify
Геометрическое броуновское движение:
\begin{align*}
\frac{dS_t}{S_t} = \mu dt + \sigma\varepsilon\sqrt{dt}, \quad \varepsilon \sim \mathcal{N}(0, 1), \sigma = const
\end{align*}

\justify
Локальная волатильность:
\begin{align*}
\frac{dS_t}{S_t} = \mu dt + \sigma(S_t, t)\varepsilon\sqrt{dt}, \quad \varepsilon \sim \mathcal{N}(0, 1)
\end{align*}

\justify
$\sigma(S_t, t)$ --- зависимость волатильности от цены базового актива и времени. Например, предположим, что если пара доллар-рубль значительно отклонится от текущего уровня (прыгнет до 80), то на рынке начнётся паника и волатильность будет выше, чем в спокойные времена при курсе 70.
\end{frame}



\begin{frame}{Стохастическая волатильность}
\justify
Геометрическое броуновское движение:
\begin{align*}
\frac{dS_t}{S_t} = \mu dt + \sigma\varepsilon\sqrt{dt}, \quad \varepsilon \sim \mathcal{N}(0, 1), \sigma = const
\end{align*}

\justify
Модель SABR (\en{Stochastic Alpha-Beta-Rho}):
\begin{align*}
dF_t &= \sigma_t(F_t)^\beta \sqrt{dt}\varepsilon, \quad \varepsilon \sim \mathcal{N}(0, 1) \\
d\sigma_t &= \alpha\sigma_t\sqrt{dt}\psi, \quad \psi \sim \mathcal{N}(0, 1) \\
Cov(\varepsilon, \psi) &= \rho
\end{align*}

\justify
$\alpha$ --- волатильность волатильности.

$\beta$ --- коэффициент скошенности.

$\rho$ --- корреляция между волатильностью и базовым активом.
\end{frame}



\begin{frame}{Калибрация моделей}
\justify
Все модели волатильности подгоняются (\en{fitted}) или калибруются (\en{calibrated}) к рынку. Мы подбираем такие значения внутренних параметров модели (например, $\alpha$, $\beta$ и $\rho$ в SABR), чтобы модель <<лучше всего>> воспроизводила наблюдаемые цены ликвидных ванильных опционов. После этого модель можно использовать для оценки более сложных экзотических продуктов.

\begin{align*}
&\text{Рыночные цены} \Rightarrow \\
&\text{Внутренние параметры} \Rightarrow \\
&\text{Цены произвольных опционов}
\end{align*}

\justify
Объективная реальность, данная нам в ощущении --- рыночные цены ликвидных ванильных опционов. Модели и параметры --- наши предположения, которые позволяют <<интерполировать>> цены неликвидных деривативов.
\end{frame}



\begin{frame}{Текущая стоимость}
\justify
Текущая стоимость (\en{present value, PV}) выплаты в $N$ рублей через $T$ лет 
--- сумма, которую участники рынка готовы заплатить сегодня за право получить эту 
выплату.

\justify
Текущая стоимость дериватива или портфеля деривативов --- сумма, которую участники рынка были бы гипотетически готовы заплатить за эти сделки или портфель. Сколько нам заплатят, если мы вычеркнем из всех контрактов своё имя и впишем имя покупателя?

\justify
Согласно МСФО, изменение PV портфеля деривативов должно быть учтено в прибыли (или убытках) текущего года, даже если выплаты по деривативам случатся через 100 лет.
\end{frame}



\begin{frame}{Текущая стоимость спот-сделки}
\justify
Мы купили на споте $N=1\,000\,000$ EURRUB по курсу $S_0 = 82$. Текущий рыночный курс $S=83$. Каково наше PV?

\justify
\centering
\begin{tabular}{c|c|c}
Дата & EUR  & RUB \\ \hline
Спот & $+N$ & $-NS_0$
\end{tabular}

\justify
$N$ евро стоят $N$ евро (пренебрегая дисконтированием на один-два дня).

\justify
$NS_0$ рублей стоят $NS_0/S$ евро.

\begin{align*}
\text{PV} = NS_0 - N\frac{S_0}{S} = N\frac{S - S_0}{S} = \EUR{1\,000\,000} \cdot \frac{83-82}{83} = \EUR{12\,048}
\end{align*}

\justify
Вычисление PV из рыночных цен (в данном случае, спот-курса) называется \alert{приведением к рынку} (\en{mark-to-market}).
\end{frame}



\begin{frame}{Текущая стоимость спот-сделки}
\justify
Мы купили на споте $N=1\,000\,000$ EURRUB по курсу $S_0 = 82$. Текущий рыночный курс $S=83$. Каково наше PV?

\justify
\centering
\begin{tabular}{r|r|r}
         & EUR               & RUB \\ \hline
Сделка   & $+1\,000\,000$ & $-82\,000\,000$ \\
Закрытие &    $-987\,952$ & $+82\,000\,000$ \\ \hline
Итого    &     $+12\,048$ & $0$
\end{tabular}

\justify
Если бы мы решили закрыть позицию на рынке, то мы смогли бы обнулить все платежи в рублях и остаться с гарантированным фиксированным платежом \EUR{12\,048}. Это и есть PV сделки.
\end{frame}



\begin{frame}{Текущая стоимость и рыночный спред}
\justify
На реальном рынке есть спред между покупкой и продажей. Допустим, что евро можно продать за 81.50 руб. и купить за 82.50. Две компании договорились друг с другом о сделке на 1 миллион евро по курсу 82.0.

\justify
Компания-покупатель:

\centering
\begin{tabular}{r|r|r}
                & EUR                   & RUB \\ \hline
Сделка по 82.0  & $+1\,000\,000$ & $-82\,000\,000$ \\
Закрытие по 81.5 & $-1\,006\,135$ & $+82\,000\,000$ \\ \hline
Итого (PV)       &      $-6\,135$ & $0$
\end{tabular}

\justify
Компания-продавец:

\centering
\begin{tabular}{r|r|r}
                 & EUR                   & RUB \\ \hline
Сделка по 82.0   & $-1\,000\,000$ & $+82\,000\,000$ \\
Закрытие по 82.5 &    $+993\,939$ & $-82\,000\,000$ \\ \hline
Итого (PV)       &      $-6\,061$ & $0$
\end{tabular} 
\end{frame}



\begin{frame}{Текущая стоимость и рыночный спред}
\justify
Можно ли обязать всех участников рынка вычислять PV и прибыль с учётом спреда между покупкой и продажей? Нет, потому что тогда вновь заключённая сделка окажется убыточной для обеих сторон.

\justify
Обычно PV вычисляется либо из <<справедливой>> (\en{fair}) средней цены между ценами покупки и продажи, либо из цены последней сделки на рынке. 

\justify
Следствие: если сделка прошла по средней цене между покупкой и продажей, то её PV --- ноль.
\end{frame}



\begin{frame}{Текущая стоимость}
\justify
Мы продали клиенту колл-опцион за премию 100 евро. На рынке такие опционы стоят 90 евро.  
Мы знаем это, потому что либо это ликвидный опцион, либо такую цену нам сказала модель, 
откалиброванная к рыночным ценам других опционов.

\justify
PV нашей позиции +10 евро.
\begin{itemize}
\item Проданный опцион: $-90$ евро.
\item Полученная премия: 100 евро.
\end{itemize}

\justify
На идеальном ликвидном рынке остальные участники будут готовы заплатить за наш портфель 
10 евро. Если цена будет ниже, например $9.90$, то кто-то предложит $9.95$, рассчитывая 
заработать 0.05 евро.

\justify
Другая интерпретация: мы можем выйти на рынок и купить опцион за 90 евро. Тогда у нас 
останется 10 евро, а позиция в опционе исчезнет. 
\end{frame}



\begin{frame}{Риск}
\justify
Риск --- возможность того, что что-то пойдёт не так, как мы планировали, и 	прибыль окажется не такой, как мы рассчитывали.

\justify
Нельзя заработать что-то большее, чем безрисковая процентная ставка, если ничем не рисковать. Финансовые компании осознанно берут на себя множество рисков:
\begin{itemize}
\item Рыночный
\item Кредитный
\item Ликвидности
\item Регуляторный
\item Технический
\item Юридический
\item Политический
\end{itemize}
\end{frame}



\begin{frame}{Рыночный риск}
\justify
\alert{Рыночный риск} (\en{market risk}) --- возможность того, что наше PV изменится как вверх, так и вниз, из-за изменения рыночных цен.

\justify
Как измерить рыночный риск? Стандартный подход --- посчитать чувствительности (\en{sensitivities}) PV к изменениям рыночных переменных. На сколько изменится PV портфеля, если цена фьючерса Brent вырастет на \$1?

\justify
Стандартные обозначения --- греки (greeks):
\begin{itemize}
\item Дельта ($\Delta$) --- чувствительность к цене базового актива.
\item Вега ($\mathcal{V}$) --- чувствительность к implied волатильности.
\item Ро ($\rho$) --- чувствительность к процентным ставкам.
\item Тета ($\Theta$) --- чувствительность к течению времени.
\item Гамма ($\Gamma$) --- чувствительность дельты к цене базового актива.
\end{itemize}
\end{frame}



\begin{frame}{Дельта}
\justify
Дельта --- чувствительность текущей стоимости портфеля $V$ к изменениям цены базового актива (например, спот-курса валюты) $S$. 
\begin{align*}
\Delta = \frac{\partial V}{\partial S}
\end{align*}

\justify
При небольшом изменении цены базового актива $dS$ текущая стоимость портфеля меняется на
\begin{align*}
dV \approx \Delta\cdot dS
\end{align*}

\justify
Это следует из определения производной:
\begin{align*}
f'(x_0) = \lim_{\Delta x \to 0} \frac{f(x_0+\Delta x) - f(x_0)}{\Delta x} = \lim_{\Delta x \to 0} \frac{\Delta f}{\Delta x}
\end{align*}
Следовательно, при малых $\Delta x$
\begin{align*}
f'(x_0) \approx \frac{\Delta f}{\Delta x} \quad \Leftrightarrow \quad \Delta f \approx f'(x_0)\Delta x
\end{align*}
\end{frame}



\begin{frame}{Дельта спот-сделки}
\justify
Спот-сделка: покупка $N=1\,000\,000$ евро по справедливому курсу $S_0=82$.
\begin{align*}
V = N - N\frac{S_0}{S} \quad \Rightarrow \quad \Delta(S) = \frac{\partial V}{\partial S} = N\frac{S_0}{S^2}
\end{align*}

\justify
Сразу после сделки $S_0=S$:
\begin{align*}
\Delta(S_0) = N\frac{S_0}{S_0^2} = \frac{N}{S_0}
\end{align*}

\justify
На каждые $dS=0.01$ (1 копейка) изменения курса PV изменяется на
\begin{align*}
dV \approx \Delta \cdot dS = \frac{N}{S_0}dS = \frac{\EUR{1\,000\,000}}{82}\cdot 0.01 = \EUR{121.95}
\end{align*}
\end{frame}



\begin{frame}{Дельта опциона}
\justify
В модели Блэка-Шоулза дельта колл-опциона со страйком $K$ и сроком экспирации $T$ лет равна
\begin{align*}
\Delta = \frac{\partial C(S, K, T, \sigma, r)}{\partial S} = N(d_1)
\end{align*}

\justify
Если у нас сложная модель цены опциона, для которой нельзя выписать аналитическую формулу, то дельту можно оценить численно как разностную производную.
\begin{align*}
\Delta \approx \frac{C(S+\delta,...) - C(S,...)}{\delta} \approx \frac{C(S+\delta,...) - C(S-\delta,...)}{2\delta}
\end{align*}

\justify
Дельта опциона --- количество единиц базового актива, которые нужно купить, чтобы реплицировать опцион.
\end{frame}



\begin{frame}{Дельта опциона}
\justify
Пример: колл-опцион со страйком $K=72$, сроком $T=0.25$ лет, $r=6\%$, $\sigma=10\%$.

\centering
\begin{tikzpicture}
\begin{axis}[
			domain=64:80,
			xtick={64,66,...,80},
			ytick={0,1,2,...,10},
			xmin=64, xmax=76,
			ymin=0, ymax=6,
			grid = major,
			xlabel={Курс сегодня ($S_0$)},
			ylabel={Цена опциона}
]
	
	\addplot[color = Set1-A, mark = none, thick]
	table[
		x=S,
		y=C_10,
		col sep=comma
	]
	{call_price.csv};
	
	%\addplot[Set1-D, very thick, dashed] {(\x >= 72)*(\x - 72) + 0.05};
	
	\node[inner sep=2pt, circle, fill, color=Set1-A] at (axis cs: 70, 0.9898) {};
	
	\addplot[color=Set1-A, dashed, thick] {0.4058 * \x - 27.4147};
	
	\node[anchor=south west] at (axis cs: 68.5, 0) {$\Delta = 0.41$};
\end{axis}
\end{tikzpicture}
\end{frame}



\begin{frame}{Дельта опциона}
\centering
\begin{tikzpicture}
\begin{axis}[
			xtick={0.5},
			xticklabel={$K$},
			ytick={-1,-0.75,...,1},
			xmin=0, xmax=1,
			ymin=-1, ymax=1,
			grid = major,
			xlabel={Цена базового актива ($S$)},
			ylabel={Дельта опциона},
			legend entries = {
  	   Колл,
  	   Пут
  },
  legend cell align={left},
  legend style={at={(0.03,0.97)},anchor=north west}
]
	
	\addplot[color = Set1-A, mark = none, thick]
	table[
		x=S,
		y=call_delta,
		col sep=comma
	]
	{black_scholes_delta.csv};
	
	\addplot[color = Set1-B, mark = none, thick]
	table[
		x=S,
		y=put_delta,
		col sep=comma
	]
	{black_scholes_delta.csv};

   \draw[thick, color=black] (axis cs: 0, 0) -- (axis cs: 1, 0);
\end{axis}
\end{tikzpicture}
\end{frame}



\begin{frame}{Котирование опционов}
\justify
Несмотря на то, что модель Блэка-Шоулза не работает (не описывает реальность), все продолжают её использовать, чтобы договариваться о ценах опционов. В разговоре удобнее оперировать волатильностью, чем премиями, чтобы понимать, что дорого, а что дёшево.

\justify
Вместо такого диалога:

--- Сколько стоит колл со страйком 74 на 3 месяца на \$1\,000?

--- 400 рублей.

\justify
Получается такой:

--- Сколько стоит колл со страйком 74 на 3 месяца на \$1\,000?

--- 15\%.

\justify
Предполагается, что каждый может подставить волатильность в формулу Блэка-Шоулза и вычислить премию.
\end{frame}



\begin{frame}{Дельта и страйки}
\justify
Что происходит с улыбкой волатильности, когда цена базового актива растёт? Обычно она смещается в ту же сторону.

\centering
\begin{tikzpicture}
\begin{axis}[
			width = \textwidth,
			height = \textheight - 2cm,
			domain=60:84,
			xtick={60,62,...,84},
			ytick={0.02,0.04,...,0.24},
			xmin=60, xmax=84,
			ymin=0, ymax=0.24,
			yticklabel={\pgfmathparse{\tick*100}\pgfmathprintnumber[precision=0]{\pgfmathresult}\%},
			grid = major,
			xlabel={Страйк ($K$)},
			ylabel={Волатильность ($\sigma$)},
			legend entries = {
  	   $S=68$,
  	   $S=74$
  },
  legend cell align={left},
  legend style={at={(0.97,0.03)},anchor=south east}
]

	\addplot[color = Set1-B, mark = none, thick, dashed] {0.0008*(\x - 68)^2 + 0.1};
	
	\addplot[color = Set1-B, mark = none, thick] {0.0008*(\x - 74)^2 + 0.1};
	
	\draw[->, >= triangle 45, thick] (68, 0.09) -- (74, 0.09);
\end{axis}
\end{tikzpicture}
\end{frame}



\begin{frame}{Дельта и страйки}
\justify
Так как улыбка волатильности следует за движениями спота, нужно очень быстро договариваться о сделках. Сейчас страйку 68 соответствует волатильность 10\%, а через полминуты из-за движения спота --- уже 11\%.

\justify
На внебиржевом рынке принято оперировать следующим страйками, которые привязаны к дельтам:
\begin{itemize}
\item DN (delta neutral) --- такой страйк $K_{DN}$, что стрэддл из колла и пута имеет дельту 0.
\item 25C --- такой страйк $K_{25C}$, что колл имеет дельту 0.25.
\item 25P --- такой страйк $K_{25P}$, что пут имеет дельту $-0.25$.
\item 10C, 10P --- аналогично 25C и 25P.
\end{itemize}

\justify
Эмпирически, implied волатильность таких страйков более стабильная (эффект sticky delta).
\end{frame}



\begin{frame}{Дельта и страйки}
\centering
\begin{tikzpicture}
\begin{axis}[
			width = \textwidth,
			height = \textheight - 2cm,
			xtick={0.10, 0.25, 0.5, 0.75, 0.90},
			xticklabels={10P, 25P, DN, 25C, 10C},
			ytick={0.02,0.04,...,0.24},
			xmin=0, xmax=1,
			ymin=0, ymax=0.24,
			yticklabel={\pgfmathparse{\tick*100}\pgfmathprintnumber[precision=0]{\pgfmathresult}\%},
			grid = major,
			xlabel={Страйк ($K$)},
			ylabel={Волатильность ($\sigma$)}
]

	\addplot[color = Set1-B, mark = none, thick, samples at={0,0.01,...,1}] {0.5*(\x - 0.5)^2 + 0.1};
\end{axis}
\end{tikzpicture}
\end{frame}
\end{document}


